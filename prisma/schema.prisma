// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider      = "prisma-client-js"
  output        = "../src/generated/prisma"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Redirects {
  id           String   @id @default(uuid())
  newURL       String
  redirectCode String   @unique
  clicks       Int      @default(0)
  createdAt    DateTime @default(now())

  clickLogs RedirectClick[]
}

model RedirectClick {
  id         String   @id @default(uuid())
  redirectId String
  clickedAt  DateTime @default(now())
  userAgent  String?
  referer    String?

  redirect Redirects @relation(fields: [redirectId], references: [id], onDelete: Cascade)

  @@index([redirectId])
  @@index([clickedAt])
}

// Better Auth Models
model User {
  id               String   @id @default(uuid())
  email            String   @unique
  emailVerified    Boolean  @default(false)
  name             String?
  firstName        String?
  lastName         String?
  studentId        String?
  image            String?
  isShopAdmin      Boolean  @default(false)
  isEventsAdmin    Boolean  @default(false)
  isRedirectsAdmin Boolean  @default(false)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  sessions    Session[]
  accounts    Account[]
  orders      Order[]
  cartItems   CartItem[]
  eventAdmins EventAdmin[] // Events this user is an admin for
}

model Session {
  id        String   @id @default(uuid())
  userId    String
  expiresAt DateTime
  token     String   @unique
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Account {
  id                    String    @id @default(uuid())
  userId                String
  accountId             String
  providerId            String
  accessToken           String?   @db.Text
  refreshToken          String?   @db.Text
  idToken               String?   @db.Text
  expiresAt             DateTime?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([providerId, accountId])
  @@index([userId])
}

model Verification {
  id         String   @id @default(uuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([identifier, value])
}

// Shop Models
model Product {
  id                  String   @id @default(uuid())
  name                String
  description         String
  price               Float
  category            String // "merch", "arsari-sari", "other"
  image               String? // Kept for backward compatibility
  imageUrls           String[] @default([]) // Array of image URLs for carousel
  imageCropPositions  Json? // Crop focus points: { [url: string]: { x: number, y: number } } (0-100%)
  stock               Int? // Optional stock tracking
  isAvailable      Boolean  @default(true)
  isPreOrder       Boolean  @default(false) // If true, stock shows order count
  isEventExclusive Boolean  @default(false) // If true, only shows under assigned events, not in All/categories
  availableSizes   String[] @default([]) // Array of sizes: ["XXXS", "XXS", "XS", "S", "M", "L", "XL", "XXL", "XXXL"]
  sizePricing      Json? // Optional size-specific pricing: { "S": 100, "M": 150, "L": 200 }
  specialNote      String? // Optional special note/warning shown during checkout
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  orderItems         OrderItem[]
  cartItems          CartItem[]
  packageItems       PackageItem[]
  packagePoolOptions PackagePoolOption[]
  eventProducts      EventProduct[]
}

// Package Models (Product Bundles)
model Package {
  id                  String   @id @default(uuid())
  name                String
  description         String
  price               Float // Bundle price (usually discounted)
  image               String? // Package hero image
  imageUrls           String[] @default([])
  imageCropPositions  Json? // Crop focus points: { [url: string]: { x: number, y: number } } (0-100%)
  isAvailable         Boolean  @default(true)
  isEventExclusive Boolean  @default(false) // If true, only shows under assigned events
  specialNote      String? // Optional note shown during checkout
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  items         PackageItem[]
  pools         PackagePool[]
  cartItems     CartItem[]
  orderItems    OrderItem[]
  eventProducts EventProduct[]
}

// Fixed items always included in a package
model PackageItem {
  id        String @id @default(uuid())
  packageId String
  productId String
  quantity  Int    @default(1)

  package Package @relation(fields: [packageId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@index([packageId])
}

// Selection pools - "Pick X from these products"
model PackagePool {
  id          String @id @default(uuid())
  packageId   String
  name        String // e.g., "Choose your shirts"
  selectCount Int // How many to pick (e.g., 2)

  package Package             @relation(fields: [packageId], references: [id], onDelete: Cascade)
  options PackagePoolOption[]

  @@index([packageId])
}

model PackagePoolOption {
  id        String @id @default(uuid())
  poolId    String
  productId String

  pool    PackagePool @relation(fields: [poolId], references: [id], onDelete: Cascade)
  product Product     @relation(fields: [productId], references: [id])

  @@index([poolId])
}

model CartItem {
  id                String   @id @default(uuid())
  userId            String
  productId         String? // Either product OR package (not both)
  packageId         String?
  quantity          Int      @default(1)
  size              String? // Selected size (for single products)
  packageSelections Json? // For packages: stores size selections per item
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product? @relation(fields: [productId], references: [id], onDelete: Cascade)
  package Package? @relation(fields: [packageId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, productId, size])
  @@index([userId, packageId])
}

model Order {
  id                   String   @id @default(uuid())
  userId               String
  totalAmount          Float
  status               String   @default("pending") // "pending", "paid", "confirmed", "completed", "cancelled"
  receiptImageUrl      String?
  gcashReferenceNumber String? // Auto-extracted from receipt image via OCR
  notes                String?
  eventId              String? // If order is for a specific event
  eventData            Json? // Stores responses to custom event checkout fields

  // Delivery Scheduling
  deliveryDate         DateTime? // Scheduled delivery date
  deliveryTimeSlot     String? // e.g., "Morning (9 AM - 12 PM)", "Afternoon (2 PM - 5 PM)"
  deliveryNotes        String? // Special delivery instructions

  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  user       User        @relation(fields: [userId], references: [id])
  orderItems OrderItem[]
  event      ShopEvent?  @relation(fields: [eventId], references: [id])

  @@index([userId])
  @@index([status])
  @@index([gcashReferenceNumber]) // Index for duplicate detection
  @@index([eventId])
}

model OrderItem {
  id                String  @id @default(uuid())
  orderId           String
  productId         String? // Either product OR package (not both)
  packageId         String?
  quantity          Int
  price             Float // Store price at time of order
  size              String? // Selected size (for single products)
  packageSelections Json? // For packages: snapshot of size selections
  purchaseCode      String? // Generated purchase code like "LLY_01-28-26-15:33_3" (comma-separated for qty > 1)

  order   Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product? @relation(fields: [productId], references: [id])
  package Package? @relation(fields: [packageId], references: [id])

  @@index([orderId])
}

// Banner Configuration
model Banner {
  id        String    @id @default(uuid())
  isActive  Boolean   @default(true)
  message   String // Banner message with optional countdown
  deadline  DateTime? // Optional deadline for countdown
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

// Shop Events (Special Event Tabs)
model ShopEvent {
  id            String   @id @default(uuid())
  name          String // "Flower Fest 2026"
  slug          String   @unique // URL-friendly identifier "flower-fest-2026"
  description   String
  heroImage     String? // Event banner/hero image
  heroImageUrls String[] @default([]) // Multiple hero images

  // Tab behavior
  isActive   Boolean @default(true)
  isPriority Boolean @default(false) // Makes it the default landing tab
  tabOrder   Int     @default(0) // Sort order for tabs
  tabLabel   String? // Custom tab label (defaults to name)

  // Timing
  startDate DateTime
  endDate   DateTime

  // Delivery & Cutoff Management
  dailyCutoffTime String? // Time of day for same-day cutoff (e.g., "14:00" for 2 PM)
  deliveryLeadDays Int @default(1) // How many days ahead for delivery (1 = next day)
  isShopClosed Boolean @default(false) // Temporarily close event shop
  closureMessage String? // Message to show when shop is closed
  allowScheduledDelivery Boolean @default(false) // Allow customers to select delivery date/time

  // Delivery Date/Time Control
  minDeliveryDate DateTime? // Earliest allowed delivery date
  maxDeliveryDate DateTime? // Latest allowed delivery date
  blockedDeliverySlots Json? // Array of blocked date/time slots: [{date: "2026-02-14", timeSlot?: "Morning", reason?: "Fully booked"}]

  // Custom component path (for event-specific UI/animations)
  componentPath String? // e.g., "flower-fest-2026" -> loads from events folder
  hasCustomCheckout Boolean @default(false) // If true, uses custom checkout component instead of generic

  // Theme configuration (colors, animations for default wrapper)
  themeConfig Json?

  // Checkout customization (for generic checkout flow)
  checkoutConfig Json? // Additional fields, messages, etc.

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  products   EventProduct[]
  categories EventCategory[] // Categories for organizing products within the event
  orders     Order[]
  admins     EventAdmin[] // Users assigned as admins for this event

  @@index([isActive])
  @@index([startDate, endDate])
}

// Event-specific Admin Assignments
model EventAdmin {
  id        String   @id @default(uuid())
  eventId   String
  userId    String
  createdAt DateTime @default(now())

  event ShopEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
  @@index([userId])
}

// Event-specific Categories for organizing products
model EventCategory {
  id           String   @id @default(uuid())
  eventId      String
  name         String // e.g., "Solo Flowers", "Mini Bouquets", "Cookies"
  displayOrder Int      @default(0)
  color        String? // Optional accent color for the category tab
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  event    ShopEvent      @relation(fields: [eventId], references: [id], onDelete: Cascade)
  products EventProduct[]

  @@unique([eventId, name])
  @@index([eventId])
  @@index([eventId, displayOrder])
}

// Products/Packages assigned to events
model EventProduct {
  id          String  @id @default(uuid())
  eventId     String
  productId   String? // Regular product
  packageId   String? // Or package
  sortOrder   Int     @default(0)
  eventPrice  Float? // Override price for this event (optional)
  productCode String? // Custom code like "LLY" for purchase code generation
  categoryId  String? // Optional category assignment

  event    ShopEvent       @relation(fields: [eventId], references: [id], onDelete: Cascade)
  product  Product?        @relation(fields: [productId], references: [id])
  package  Package?        @relation(fields: [packageId], references: [id])
  category EventCategory?  @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  @@index([eventId])
  @@index([eventId, sortOrder])
  @@index([categoryId])
}

// Shop Analytics - Click Tracking
model ShopClick {
  id        String   @id @default(uuid())
  path      String // "/shop", "/shop?tab=merch", etc.
  eventId   String? // If click was on an event tab
  userAgent String?
  referer   String?
  clickedAt DateTime @default(now())

  @@index([clickedAt])
  @@index([path])
  @@index([eventId])
}

// Shop Analytics - Purchase Tracking (for graphs)
model ShopPurchase {
  id          String   @id @default(uuid())
  orderId     String
  eventId     String? // If purchase was for an event
  totalAmount Float
  itemCount   Int
  purchasedAt DateTime @default(now())

  @@index([purchasedAt])
  @@index([eventId])
  @@index([eventId, purchasedAt])
}

// Shop Settings (Google Sheets, etc.)
model ShopSettings {
  id                String   @id @default(uuid())
  key               String   @unique // e.g., "googleSheets"
  value             Json // Stores settings as JSON
  updatedBy         String? // User ID who last updated
  updatedAt         DateTime @updatedAt
  createdAt         DateTime @default(now())

  @@index([key])
}

// Email Log - Tracks all confirmation emails sent
model EmailLog {
  id            String   @id @default(uuid())
  provider      String // "smtp" or "resend"
  recipient     String // Email address of recipient
  subject       String
  emailType     String // "order_confirmation", "test", "custom"
  orderId       String? // Optional order ID for order confirmation emails
  userId        String? // Optional user ID
  status        String // "sent", "failed"
  errorMessage  String? // Error message if failed
  providerId    String? // Message ID from email provider (for tracking)
  sentAt        DateTime @default(now())

  @@index([recipient])
  @@index([orderId])
  @@index([sentAt])
  @@index([status])
  @@index([emailType])
}
